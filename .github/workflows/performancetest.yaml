name: Performance test

on:
  workflow_dispatch:

jobs:
  performance-test:
    name: Performance test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          path: main

      - uses: actions/checkout@v3
        with:
          fetch-depth: 1
          path: clojure-lsp
          repository: clojure-lsp/clojure-lsp

      - name: Prepare java
        uses: actions/setup-java@v1
        with:
          java-version: 17

      - name: Install Clojure
        uses: DeLaGuardo/setup-clojure@master
        with:
          cli: '1.10.3.1013'
          bb: '0.9.161'

      - name: Run functional tests
        run: clojure -M:test
        working-directory: main

      - name: Run performance tests
        run: clojure -X:jmh :output '"result.clj"' :status true
        working-directory: main